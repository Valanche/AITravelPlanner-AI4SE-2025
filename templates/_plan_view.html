<style>
    .itinerary-scrollable {
        max-height: 85vh; /* Adjusted height */
        overflow-y: auto;
    }
    .item-wrapper:hover .insert-button-container {
        display: block !important;
    }
</style>
<div class="row d-flex">
    <div class="col-md-4">
        <h5>行程</h5>
        {% if plan.days %}
            {% set total_estimated_cost = namespace(value=0) %}
            {% set total_actual_cost = namespace(value=0) %}
            {% for day in plan.days %}
                {% for item in day.items %}
                    {% set total_estimated_cost.value = total_estimated_cost.value + item.estimated_cost %}
                    {% for cost in item.actual_costs %}
                        {% set total_actual_cost.value = total_actual_cost.value + cost.amount %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
            <h4>预计总花费: {{ "%.2f"|format(total_estimated_cost.value) }}</h4>
            <h4 id="total-actual-cost">实际总花费: {{ "%.2f"|format(total_actual_cost.value) }}</h4>
            <div class="itinerary-scrollable">
            {% for day in plan.days %}
                <h4 class="mt-4">{{ day.date.strftime('%Y-%m-%d') }}</h4>
                <div class="list-group" id="day-{{ day.id }}">
                    {% for item in day.items %}
                        <div class="item-wrapper">
                            {% set item_actual_cost = namespace(value=0) %}
                            {% for cost in item.actual_costs %}
                                {% set item_actual_cost.value = item_actual_cost.value + cost.amount %}
                            {% endfor %}
                            <div class="list-group-item mb-2" style="position: relative; padding-bottom: 50px;" id="item-{{ item.id }}">
                                <h5 class="mb-1">{{ item.item_type }}: {{ item.description }}</h5>
                                <small>开始: {{ item.start_time.strftime('%H:%M') if item.start_time else 'N/A' }}</small>
                                <small>结束: {{ item.end_time.strftime('%H:%M') if item.end_time else 'N/A' }}</small>
                                <p class="mb-1">预计花费: {{ "%.2f"|format(item.estimated_cost) }}</p>
                                <p class="mb-1" id="item-actual-cost-{{ item.id }}">实际花费: {{ "%.2f"|format(item_actual_cost.value) }}</p>
                                {% if item.location %}
                                    <p class="mb-1">地点: {% if item.location.city %}{{ item.location.city }}, {% endif %}{{ item.location.name }}</p>
                                {% endif %}
                                <div class="button-container" style="position: absolute; bottom: 10px; right: 10px; display: flex; gap: 5px;">
                                    {% if is_details_view %}
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="openEditModal('{{ item.id }}', '{{ item.description }}', '{{ item.start_time.isoformat() if item.start_time else '' }}', '{{ item.end_time.isoformat() if item.end_time else '' }}', '{{ item.location.name if item.location else '' }}', '{{ item.location.city if item.location else '' }}', '{{ item.estimated_cost }}', '{{ item.item_type }}')">
                                        编辑
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteItem('{{ item.id }}')">
                                        删除
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" id="actual-costs-btn-{{ item.id }}" onclick="event.stopPropagation(); toggleActualCosts('{{ item.id }}')">
                                        实际花费
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-info btn-sm navigate-btn" 
                                            id="navigate-btn-{{ item.id }}"
                                            onclick="event.stopPropagation(); showTransportSelect('{{ item.id }}', '{{ loop.previtem.location.name if loop.previtem and loop.previtem.location else '' }}', '{{ item.location.name if item.location else '' }}')">
                                        导航
                                    </button>
                                    <select class="form-select form-select-sm transport-select" id="transport-select-{{ item.id }}" style="display: none;" onchange="navigateWithSelectedType('{{ item.id }}')">
                                        <option selected disabled>选择...</option>
                                        <option value="Driving">驾车</option>
                                        <option value="Walking">步行</option>
                                        <option value="Cycling">骑行</option>
                                        <option value="Public Transport">公交</option>
                                    </select>
                                </div>
                            </div>
                            {% if is_details_view %}
                            <div id="actual-costs-{{ item.id }}" class="list-group-item mb-2 ms-4" style="display: none;" onclick="event.stopPropagation();">
                                <p class="mb-1 mt-2">实际花费:</p>
                                <ul>
                                    {% for cost in item.actual_costs %}
                                        <li class="d-flex justify-content-between align-items-center" id="cost-li-{{ cost.id }}">
                                            {{ cost.name }}: {{ "%.2f"|format(cost.amount) }}
                                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteActualCost('{{ cost.id }}')">删除</button>
                                        </li>
                                    {% endfor %}
                                </ul>
                                <hr>
                                <h6>添加新花费</h6>
                                <form id="add-cost-form-{{ item.id }}">
                                    <input type="hidden" name="plan_id" value="{{ plan.id }}">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" name="name" class="form-control" placeholder="名称" required>
                                        </div>
                                        <div class="col">
                                            <input type="number" name="amount" class="form-control" placeholder="金额" required step="0.01">
                                        </div>
                                        <div class="col">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="addActualCost('{{ item.id }}')">添加</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="text-center my-2 insert-button-container" style="display: none;">
                                <button class="btn btn-sm btn-success" onclick="openInsertModal('{{ day.id }}', {{ item.order }})">+</button>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            </div>
        {% else %}
            <p>此计划没有行程项目。</p>
        {% endif %}
    </div>
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-body p-0">
                <div id="container" style="height: 100%; min-height: 600px;"></div>
                <div id="panel" style="position: absolute; background-color: white; max-height: 90%; overflow-y: auto; top: 10px; right: 10px; width: 280px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Edit/Insert -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">编辑项</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <input type="hidden" id="modalItemId" name="itemId">
                    <input type="hidden" id="modalDayId" name="dayId">
                    <input type="hidden" id="modalAfterItemOrder" name="afterItemOrder">
                    <div class="mb-3">
                        <label for="modalItemType" class="form-label">类型</label>
                        <input type="text" class="form-control" id="modalItemType" name="item_type" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="modalDescription" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="modalStartTime" class="form-label">开始时间</label>
                        <input type="datetime-local" class="form-control" id="modalStartTime" name="start_time">
                    </div>
                    <div class="mb-3">
                        <label for="modalEndTime" class="form-label">结束时间</label>
                        <input type="datetime-local" class="form-control" id="modalEndTime" name="end_time">
                    </div>
                    <div class="mb-3">
                        <label for="modalLocation" class="form-label">地点</label>
                        <input type="text" class="form-control" id="modalLocation" name="location">
                    </div>
                    <div class="mb-3">
                        <label for="modalCity" class="form-label">城市</label>
                        <input type="text" class="form-control" id="modalCity" name="city">
                    </div>
                    <div class="mb-3">
                        <label for="modalEstimatedCost" class="form-label">预计花费</label>
                        <input type="number" class="form-control" id="modalEstimatedCost" name="estimated_cost" step="0.01">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">保存更改</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
let itemModal;
document.addEventListener("DOMContentLoaded", function() {
  itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
});

function openEditModal(itemId, description, startTime, endTime, location, city, estimatedCost, itemType) {
    document.getElementById('itemModalLabel').textContent = '编辑项目';
    document.getElementById('modalItemId').value = itemId;
    document.getElementById('modalDayId').value = '';
    document.getElementById('modalAfterItemOrder').value = '';
    document.getElementById('modalDescription').value = description;
    document.getElementById('modalStartTime').value = startTime ? new Date(startTime).toISOString().slice(0, 16) : '';
    document.getElementById('modalEndTime').value = endTime ? new Date(endTime).toISOString().slice(0, 16) : '';
    document.getElementById('modalLocation').value = location;
    document.getElementById('modalCity').value = city;
    document.getElementById('modalEstimatedCost').value = estimatedCost;
    document.getElementById('modalItemType').value = itemType;
    itemModal.show();
}

function openInsertModal(dayId, afterItemOrder) {
    document.getElementById('itemModalLabel').textContent = '插入新项目';
    document.getElementById('itemForm').reset();
    document.getElementById('modalDayId').value = dayId;
    document.getElementById('modalAfterItemOrder').value = afterItemOrder;
    document.getElementById('modalItemId').value = '';
    itemModal.show();
}

function saveItem() {
    const itemId = document.getElementById('modalItemId').value;
    const dayId = document.getElementById('modalDayId').value;
    const afterItemOrder = document.getElementById('modalAfterItemOrder').value;

    const form = document.getElementById('itemForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    if (itemId) { // This is an update
        const url = `/itinerary-item/${itemId}/update`;
        const method = 'POST';
        const body = JSON.stringify(data);

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                itemModal.hide();
                location.reload();
            } else {
                alert('保存项目失败：' + data.error);
            }
        });
    } else { // This is an insert
        const dayContainer = document.querySelector(`#day-${dayId}`);
        const allItems = Array.from(dayContainer.querySelectorAll('div[id^="item-"]'));
        
        const newOrder = afterItemOrder ? parseInt(afterItemOrder) + 1 : 0;
        data.order = newOrder;

        const itemsToUpdate = [];
        for (let i = newOrder; i < allItems.length; i++) {
            const currentItem = allItems[i];
            const currentItemId = currentItem.id.replace('item-', '');
            itemsToUpdate.push({id: currentItemId, order: i + 1});
        }

        const url = `/day/${dayId}/insert-and-reorder`;
        const method = 'POST';
        const body = JSON.stringify({
            new_item_data: data,
            items_to_update: itemsToUpdate
        });

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                itemModal.hide();
                location.reload();
            } else {
                alert('保存项目失败：' + data.error);
            }
        });
    }
}

function deleteItem(itemId) {
    if (!confirm('您确定要删除此项吗？')) {
        return;
    }

    fetch(`/itinerary-item/${itemId}/delete`, {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('删除失败：' + data.error);
        }
    });
}

function toggleActualCosts(itemId) {
    var x = document.getElementById("actual-costs-" + itemId);
    if (x) { // Check if the element exists
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }
}

function deleteActualCost(costId) {
    if (!confirm('您确定要删除此花费吗？')) {
        return;
    }

    fetch(`/actual-cost/${costId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const liElement = document.getElementById(`cost-li-${costId}`);
            const amountText = liElement.textContent.match(/[\d.]+/)[0];
            const deletedAmount = parseFloat(amountText);
            const itemId = liElement.closest('div[id^="actual-costs-"]').id.replace('actual-costs-', '');

            liElement.remove();

            // Update item's total actual cost
            const itemActualCostElement = document.getElementById(`item-actual-cost-${itemId}`);
            let currentItemTotal = parseFloat(itemActualCostElement.textContent.match(/[\d.]+/)[0]);
            currentItemTotal -= deletedAmount;
            itemActualCostElement.textContent = `实际花费: ${currentItemTotal.toFixed(2)}`;

            // Update overall total actual cost
            const totalActualCostElement = document.getElementById('total-actual-cost');
            let currentTotal = parseFloat(totalActualCostElement.textContent.match(/[\d.]+/)[0]);
            currentTotal -= deletedAmount;
            totalActualCostElement.textContent = `实际总花费: ${currentTotal.toFixed(2)}`;
        } else {
            alert('删除花费失败。');
        }
    });
}

function addActualCost(itemId) {
    const form = document.getElementById(`add-cost-form-${itemId}`);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/itinerary-item/${itemId}/costs`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const ul = document.querySelector(`#actual-costs-${itemId} ul`);
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between align-items-center';
            li.id = `cost-li-${data.cost.id}`;
            li.innerHTML = `
                ${data.cost.name}: ${data.cost.amount.toFixed(2)}
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteActualCost('${data.cost.id}')">删除</button>
            `;
            ul.appendChild(li);
            form.reset();
            
            // Update item's total actual cost
            const itemActualCostElement = document.getElementById(`item-actual-cost-${itemId}`);
            let currentItemTotal = parseFloat(itemActualCostElement.textContent.match(/[\d.]+/)[0]);
            currentItemTotal += data.cost.amount;
            itemActualCostElement.textContent = `实际花费: ${currentItemTotal.toFixed(2)}`;

            // Update overall total actual cost
            const totalActualCostElement = document.getElementById('total-actual-cost');
            let currentTotal = parseFloat(totalActualCostElement.textContent.match(/[\d.]+/)[0]);
            currentTotal += data.cost.amount;
            totalActualCostElement.textContent = `实际总花费: ${currentTotal.toFixed(2)}`;
        } else {
            alert('添加花费失败。');
        }
    });
}

const currentNavigation = {};

function showTransportSelect(itemId, startLocation, endLocation) {
    if (!startLocation) {
        alert("缺少出发点，请检查上一个项目及其地点是否存在");
        return;
    }

    currentNavigation[itemId] = { start: startLocation, end: endLocation };

    document.getElementById(`navigate-btn-${itemId}`).style.display = 'none';
    document.getElementById(`transport-select-${itemId}`).style.display = 'block';

    const actualCostsBtn = document.getElementById(`actual-costs-btn-${itemId}`);
    if (actualCostsBtn) {
        actualCostsBtn.style.display = 'none';
    }
}

function navigateWithSelectedType(itemId) {
    const selectElement = document.getElementById(`transport-select-${itemId}`);
    const transportType = selectElement.value;
    const navInfo = currentNavigation[itemId];

    if (transportType && navInfo) {
        planRoute(transportType, navInfo.start, navInfo.end);
    }

    // Reset UI
    selectElement.style.display = 'none';
    selectElement.selectedIndex = 0; // Reset to the "Choose..." option
    document.getElementById(`navigate-btn-${itemId}`).style.display = 'block';

    const actualCostsBtn = document.getElementById(`actual-costs-btn-${itemId}`);
    if (actualCostsBtn) {
        actualCostsBtn.style.display = 'block';
    }
}

</script>

<!-- Map Scripts -->
<script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode: '{{ amap_security_key }}',
    };
</script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key={{ amap_key }}&plugin=AMap.Driving,AMap.Walking,AMap.Riding,AMap.Transfer,AMap.Adaptor"></script>
<script>
    var map = new AMap.Map('container', {
        resizeEnable: true, //是否监控地图容器尺寸变化
        zoom: 10, //初始化地图层级
        center: [116.397428, 39.90923] //初始化地图中心点
    });

    var locationCityMap = {{ location_city_map | tojson }};

    var driving, walking, riding, transfer;
    map.on('complete', function() {
        driving = new AMap.Driving({ map: map, panel: "panel" });
        walking = new AMap.Walking({ map: map, panel: "panel" });
        riding = new AMap.Riding({ map: map, panel: "panel" });
        transfer = new AMap.Transfer({ map: map, panel: "panel" });
    });

    function clearRoute() {
        if (driving) driving.clear();
        if (walking) walking.clear();
        if (riding) riding.clear();
        if (transfer) transfer.clear();
    }

    function planRoute(transportType, startLocation, endLocation) {
        clearRoute();
        
        var startCity = locationCityMap[startLocation];
        var endCity = locationCityMap[endLocation];

        var searchPoints = [
            { keyword: startLocation, city: startCity },
            { keyword: endLocation, city: endCity }
        ];

        switch (transportType) {
            case 'Driving':
                driving.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get driving data: ' + result);
                    }
                });
                break;
            case 'Walking':
                walking.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get walking data: ' + result);
                    }
                });
                break;
            case 'Cycling':
                riding.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get cycling data: ' + result);
                    }
                });
                break;
            case 'Public Transport':
                var transCity = startCity; // Default to start city
                if (startCity !== endCity) {
                    console.warn("Cross-city public transport is complex. Using start city for the query.");
                }
                transfer.setCity(transCity);
                transfer.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get public transport data: ' + result);
                    }
                });
                break;
            default:
                alert('Unsupported transport type: ' + transportType);
        }
    }
</script>
{% endblock %}