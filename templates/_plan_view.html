<div class="row d-flex">
    <div class="col-md-4">
        <h5>Itinerary</h5>
        {% if plan.days %}
            {% set total_estimated_cost = namespace(value=0) %}
            {% for day in plan.days %}
                <h4 class="mt-4">{{ day.date.strftime('%Y-%m-%d') }}</h4>
                <div class="list-group">
                    {% for item in day.items %}
                        <div class="list-group-item mb-2" onclick="toggleActualCosts('{{ item.id }}')" style="cursor: pointer;">
                            <h5 class="mb-1">{{ item.item_type }}: {{ item.description }}</h5>
                            <small>Start: {{ item.start_time.strftime('%H:%M') if item.start_time else 'N/A' }}</small>
                            <small>End: {{ item.end_time.strftime('%H:%M') if item.end_time else 'N/A' }}</small>
                            <p class="mb-1">Estimated Cost: {{ "%.2f"|format(item.estimated_cost) }} {{ item.estimated_cost_currency }}</p>
                            {% if item.location %}
                                <p class="mb-1">Location: {{ item.location.name }}</p>
                            {% endif %}
                        </div>
                        {% if is_details_view %}
                        <div id="actual-costs-{{ item.id }}" class="list-group-item mb-2 ms-4" style="display: none;" onclick="event.stopPropagation();">
                            <p class="mb-1 mt-2">Actual Costs:</p>
                            <ul>
                                {% for cost in item.actual_costs %}
                                    <li class="d-flex justify-content-between align-items-center" id="cost-li-{{ cost.id }}">
                                        {{ cost.name }}: {{ "%.2f"|format(cost.amount) }} {{ cost.currency }}
                                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteActualCost('{{ cost.id }}')">Delete</button>
                                    </li>
                                {% endfor %}
                            </ul>
                            <hr>
                            <h6>Add New Cost</h6>
                            <form id="add-cost-form-{{ item.id }}">
                                <input type="hidden" name="plan_id" value="{{ plan.id }}">
                                <div class="row">
                                    <div class="col">
                                        <input type="text" name="name" class="form-control" placeholder="Name" required>
                                    </div>
                                    <div class="col">
                                        <input type="number" name="amount" class="form-control" placeholder="Amount" required step="0.01">
                                    </div>
                                    <div class="col">
                                        <input type="text" name="currency" class="form-control" placeholder="Currency" required>
                                    </div>
                                    <div class="col">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="addActualCost('{{ item.id }}')">Add</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        {% endif %}
                        {% if item.transportations %}
                            <div class="list-group-item mb-2 ms-4">
                                <h6 class="mt-2">Transportations:</h6>
                                <ul class="list-unstyled">
                                    {% for transportation in item.transportations %}
                                        <li id="display-transportation-{{ transportation.id }}">
                                            {{ transportation.transport_type }}: {{ transportation.start_location }} to {{ transportation.end_location }}
                                            ({{ transportation.estimated_time }}, {{ "%.2f"|format(transportation.estimated_cost) }} {{ item.estimated_cost_currency }})
                                            <div class="d-flex justify-content-end mt-2">
                                                <button type="button" class="btn btn-info btn-sm me-2" onclick="event.stopPropagation(); planRoute('{{ transportation.transport_type }}', '{{ transportation.start_location }}', '{{ transportation.end_location }}')">Navigate</button>
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); toggleEdit('{{ transportation.id }}')">Edit</button>
                                            </div>
                                        </li>
                                        <li id="edit-transportation-{{ transportation.id }}" style="display: none;">
                                            <form id="edit-transportation-form-{{ transportation.id }}">
                                                <input type="hidden" name="plan_id" value="{{ plan.id }}">
                                                <div class="mb-2">
                                                    <label>Transport Type</label>
                                                    <select name="transport_type" class="form-control">
                                                        <option value="Walking" {% if transportation.transport_type == 'Walking' %}selected{% endif %}>Walking</option>
                                                        <option value="Cycling" {% if transportation.transport_type == 'Cycling' %}selected{% endif %}>Cycling</option>
                                                        <option value="Public Transport" {% if transportation.transport_type == 'Public Transport' %}selected{% endif %}>Public Transport</option>
                                                        <option value="Driving" {% if transportation.transport_type == 'Driving' %}selected{% endif %}>Driving</option>
                                                    </select>
                                                </div>
                                                <div class="mb-2">
                                                    <label>Start Location</label>
                                                    <input type="text" name="start_location" class="form-control" value="{{ transportation.start_location }}">
                                                </div>
                                                <div class="mb-2">
                                                    <label>End Location</label>
                                                    <input type="text" name="end_location" class="form-control" value="{{ transportation.end_location }}">
                                                </div>
                                                <div class="mb-2">
                                                    <label>Estimated Time</label>
                                                    <input type="text" name="estimated_time" class="form-control" value="{{ transportation.estimated_time }}">
                                                </div>
                                                <div class="mb-2">
                                                    <label>Estimated Cost</label>
                                                    <input type="number" name="estimated_cost" class="form-control" value="{{ transportation.estimated_cost }}" step="0.01">
                                                </div>
                                                <button type="button" class="btn btn-primary btn-sm" onclick="saveTransportation('{{ transportation.id }}')">Save</button>
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEdit('{{ transportation.id }}')">Cancel</button>
                                            </form>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endfor %}
            <hr>
            <h4>Total Estimated Cost: {{ "%.2f"|format(total_estimated_cost.value) }}</h4>
        {% else %}
            <p>No itinerary items for this plan.</p>
        {% endif %}
    </div>
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-body p-0">
                <div id="container" style="height: 100%; min-height: 600px;"></div>
                <div id="panel" style="position: absolute; background-color: white; max-height: 90%; overflow-y: auto; top: 10px; right: 10px; width: 280px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleActualCosts(itemId) {
    var x = document.getElementById("actual-costs-" + itemId);
    if (x) { // Check if the element exists
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }
}

function toggleEdit(transportationId) {
    var displayView = document.getElementById("display-transportation-" + transportationId);
    var editView = document.getElementById("edit-transportation-" + transportationId);

    if (displayView.style.display === "none") {
        displayView.style.display = "block";
        editView.style.display = "none";
    } else {
        displayView.style.display = "none";
        editView.style.display = "block";
    }
}

function deleteActualCost(costId) {
    if (!confirm('Are you sure you want to delete this cost?')) {
        return;
    }

    fetch(`/actual-cost/${costId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`cost-li-${costId}`).remove();
        } else {
            alert('Failed to delete cost.');
        }
    });
}

function addActualCost(itemId) {
    const form = document.getElementById(`add-cost-form-${itemId}`);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/itinerary-item/${itemId}/costs`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const ul = document.querySelector(`#actual-costs-${itemId} ul`);
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between align-items-center';
            li.id = `cost-li-${data.cost.id}`;
            li.innerHTML = `
                ${data.cost.name}: ${data.cost.amount.toFixed(2)} ${data.cost.currency}
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteActualCost('${data.cost.id}')">Delete</button>
            `;
            ul.appendChild(li);
            form.reset();
        } else {
            alert('Failed to add cost.');
        }
    });
}

function saveTransportation(transportationId) {
    const form = document.getElementById(`edit-transportation-form-${transportationId}`);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/transportation/${transportationId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const displayView = document.getElementById(`display-transportation-${transportationId}`);
            displayView.innerHTML = `
                ${data.transportation.transport_type}: ${data.transportation.start_location} to ${data.transportation.end_location}
                (${data.transportation.estimated_time}, ${data.transportation.estimated_cost.toFixed(2)} USD)
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEdit('${transportationId}')">Edit</button>
            `;
            toggleEdit(transportationId);
        } else {
            alert('Failed to update transportation.');
        }
    });
}
</script>

<!-- Map Scripts -->
<script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode: '{{ amap_security_key }}',
    };
</script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key={{ amap_key }}&plugin=AMap.Driving,AMap.Walking,AMap.Riding,AMap.Transfer,AMap.Adaptor"></script>
<script>
    var map = new AMap.Map('container', {
        resizeEnable: true, //是否监控地图容器尺寸变化
        zoom: 10, //初始化地图层级
        center: [116.397428, 39.90923] //初始化地图中心点
    });

    var locationCityMap = {{ location_city_map | tojson }};

    var driving, walking, riding, transfer;
    map.on('complete', function() {
        driving = new AMap.Driving({ map: map, panel: "panel" });
        walking = new AMap.Walking({ map: map, panel: "panel" });
        riding = new AMap.Riding({ map: map, panel: "panel" });
        transfer = new AMap.Transfer({ map: map, panel: "panel" });
    });

    function clearRoute() {
        if (driving) driving.clear();
        if (walking) walking.clear();
        if (riding) riding.clear();
        if (transfer) transfer.clear();
    }

    function planRoute(transportType, startLocation, endLocation) {
        clearRoute();
        
        var startCity = locationCityMap[startLocation];
        var endCity = locationCityMap[endLocation];

        var searchPoints = [
            { keyword: startLocation, city: startCity },
            { keyword: endLocation, city: endCity }
        ];

        switch (transportType) {
            case 'Driving':
                driving.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get driving data: ' + result);
                    }
                });
                break;
            case 'Walking':
                walking.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get walking data: ' + result);
                    }
                });
                break;
            case 'Cycling':
                riding.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get cycling data: ' + result);
                    }
                });
                break;
            case 'Public Transport':
                var transCity = startCity; // Default to start city
                if (startCity !== endCity) {
                    console.warn("Cross-city public transport is complex. Using start city for the query.");
                }
                transfer.setCity(transCity);
                transfer.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get public transport data: ' + result);
                    }
                });
                break;
            default:
                alert('Unsupported transport type: ' + transportType);
        }
    }
</script>


