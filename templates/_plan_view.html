<style>
    .itinerary-scrollable {
        max-height: 85vh; /* Adjusted height */
        overflow-y: auto;
    }
    .item-wrapper:hover .insert-button-container {
        display: block !important;
    }
</style>
<div class="row d-flex">
    <div class="col-md-4 itinerary-scrollable">
        <h5>Itinerary</h5>
        {% if plan.days %}
            {% set total_estimated_cost = namespace(value=0) %}
            {% for day in plan.days %}
                <h4 class="mt-4">{{ day.date.strftime('%Y-%m-%d') }}</h4>
                <div class="list-group" id="day-{{ day.id }}">
                    {% for item in day.items %}
                        <div class="item-wrapper">
                            <div class="list-group-item mb-2" style="position: relative; padding-bottom: 50px;" id="item-{{ item.id }}">
                                <h5 class="mb-1">{{ item.item_type }}: {{ item.description }}</h5>
                                <small>Start: {{ item.start_time.strftime('%H:%M') if item.start_time else 'N/A' }}</small>
                                <small>End: {{ item.end_time.strftime('%H:%M') if item.end_time else 'N/A' }}</small>
                                <p class="mb-1">Estimated Cost: {{ "%.2f"|format(item.estimated_cost) }} {{ item.estimated_cost_currency }}</p>
                                {% if item.location %}
                                    <p class="mb-1">Location: {% if item.location.city %}{{ item.location.city }}, {% endif %}{{ item.location.name }}</p>
                                {% endif %}
                                <div class="button-container" style="position: absolute; bottom: 10px; right: 10px; display: flex; gap: 5px;">
                                    {% if is_details_view %}
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="openEditModal('{{ item.id }}', '{{ item.description }}', '{{ item.start_time.isoformat() if item.start_time else '' }}', '{{ item.end_time.isoformat() if item.end_time else '' }}', '{{ item.location.name if item.location else '' }}', '{{ item.location.city if item.location else '' }}', '{{ item.estimated_cost }}', '{{ item.estimated_cost_currency }}', '{{ item.item_type }}')">
                                        Edit
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteItem('{{ item.id }}')">
                                        Delete
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" id="actual-costs-btn-{{ item.id }}" onclick="event.stopPropagation(); toggleActualCosts('{{ item.id }}')">
                                        Actual Costs
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-info btn-sm navigate-btn" 
                                            id="navigate-btn-{{ item.id }}"
                                            onclick="event.stopPropagation(); showTransportSelect('{{ item.id }}', '{{ loop.previtem.location.name if loop.previtem and loop.previtem.location else '' }}', '{{ item.location.name if item.location else '' }}')">
                                        Navigate
                                    </button>
                                    <select class="form-select form-select-sm transport-select" id="transport-select-{{ item.id }}" style="display: none;" onchange="navigateWithSelectedType('{{ item.id }}')">
                                        <option selected disabled>Choose...</option>
                                        <option value="Driving">Driving</option>
                                        <option value="Walking">Walking</option>
                                        <option value="Cycling">Cycling</option>
                                        <option value="Public Transport">Public Transport</option>
                                    </select>
                                </div>
                            </div>
                            {% if is_details_view %}
                            <div id="actual-costs-{{ item.id }}" class="list-group-item mb-2 ms-4" style="display: none;" onclick="event.stopPropagation();">
                                <p class="mb-1 mt-2">Actual Costs:</p>
                                <ul>
                                    {% for cost in item.actual_costs %}
                                        <li class="d-flex justify-content-between align-items-center" id="cost-li-{{ cost.id }}">
                                            {{ cost.name }}: {{ "%.2f"|format(cost.amount) }} {{ cost.currency }}
                                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteActualCost('{{ cost.id }}')">Delete</button>
                                        </li>
                                    {% endfor %}
                                </ul>
                                <hr>
                                <h6>Add New Cost</h6>
                                <form id="add-cost-form-{{ item.id }}">
                                    <input type="hidden" name="plan_id" value="{{ plan.id }}">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" name="name" class="form-control" placeholder="Name" required>
                                        </div>
                                        <div class="col">
                                            <input type="number" name="amount" class="form-control" placeholder="Amount" required step="0.01">
                                        </div>
                                        <div class="col">
                                            <input type="text" name="currency" class="form-control" placeholder="Currency" required>
                                        </div>
                                        <div class="col">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="addActualCost('{{ item.id }}')">Add</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="text-center my-2 insert-button-container" style="display: none;">
                                <button class="btn btn-sm btn-success" onclick="openInsertModal('{{ day.id }}', {{ item.order }})">+</button>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            <hr>
            <h4>Total Estimated Cost: {{ "%.2f"|format(total_estimated_cost.value) }}</h4>
        {% else %}
            <p>No itinerary items for this plan.</p>
        {% endif %}
    </div>
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-body p-0">
                <div id="container" style="height: 100%; min-height: 600px;"></div>
                <div id="panel" style="position: absolute; background-color: white; max-height: 90%; overflow-y: auto; top: 10px; right: 10px; width: 280px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Edit/Insert -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">Edit Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <input type="hidden" id="modalItemId" name="itemId">
                    <input type="hidden" id="modalDayId" name="dayId">
                    <input type="hidden" id="modalAfterItemOrder" name="afterItemOrder">
                    <div class="mb-3">
                        <label for="modalItemType" class="form-label">Type</label>
                        <input type="text" class="form-control" id="modalItemType" name="item_type" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="modalDescription" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="modalStartTime" class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-control" id="modalStartTime" name="start_time">
                    </div>
                    <div class="mb-3">
                        <label for="modalEndTime" class="form-label">End Time</label>
                        <input type="datetime-local" class="form-control" id="modalEndTime" name="end_time">
                    </div>
                    <div class="mb-3">
                        <label for="modalLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="modalLocation" name="location">
                    </div>
                    <div class="mb-3">
                        <label for="modalCity" class="form-label">City</label>
                        <input type="text" class="form-control" id="modalCity" name="city">
                    </div>
                    <div class="mb-3">
                        <label for="modalEstimatedCost" class="form-label">Estimated Cost</label>
                        <input type="number" class="form-control" id="modalEstimatedCost" name="estimated_cost" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="modalEstimatedCostCurrency" class="form-label">Currency</label>
                        <input type="text" class="form-control" id="modalEstimatedCostCurrency" name="estimated_cost_currency">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
let itemModal;
document.addEventListener("DOMContentLoaded", function() {
  itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
});

function openEditModal(itemId, description, startTime, endTime, location, city, estimatedCost, currency, itemType) {
    document.getElementById('itemModalLabel').textContent = 'Edit Item';
    document.getElementById('modalItemId').value = itemId;
    document.getElementById('modalDayId').value = '';
    document.getElementById('modalAfterItemOrder').value = '';
    document.getElementById('modalDescription').value = description;
    document.getElementById('modalStartTime').value = startTime ? new Date(startTime).toISOString().slice(0, 16) : '';
    document.getElementById('modalEndTime').value = endTime ? new Date(endTime).toISOString().slice(0, 16) : '';
    document.getElementById('modalLocation').value = location;
    document.getElementById('modalCity').value = city;
    document.getElementById('modalEstimatedCost').value = estimatedCost;
    document.getElementById('modalEstimatedCostCurrency').value = currency;
    document.getElementById('modalItemType').value = itemType;
    itemModal.show();
}

function openInsertModal(dayId, afterItemOrder) {
    document.getElementById('itemModalLabel').textContent = 'Insert New Item';
    document.getElementById('itemForm').reset();
    document.getElementById('modalDayId').value = dayId;
    document.getElementById('modalAfterItemOrder').value = afterItemOrder;
    document.getElementById('modalItemId').value = '';
    itemModal.show();
}

function saveItem() {
    const itemId = document.getElementById('modalItemId').value;
    const dayId = document.getElementById('modalDayId').value;
    const afterItemOrder = document.getElementById('modalAfterItemOrder').value;

    const form = document.getElementById('itemForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    if (itemId) { // This is an update
        const url = `/itinerary-item/${itemId}/update`;
        const method = 'POST';
        const body = JSON.stringify(data);

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                itemModal.hide();
                location.reload();
            } else {
                alert('Failed to save item: ' + data.error);
            }
        });
    } else { // This is an insert
        const dayContainer = document.querySelector(`#day-${dayId}`);
        const allItems = Array.from(dayContainer.querySelectorAll('div[id^="item-"]'));
        
        const newOrder = afterItemOrder ? parseInt(afterItemOrder) + 1 : 0;
        data.order = newOrder;

        const itemsToUpdate = [];
        for (let i = newOrder; i < allItems.length; i++) {
            const currentItem = allItems[i];
            const currentItemId = currentItem.id.replace('item-', '');
            itemsToUpdate.push({id: currentItemId, order: i + 1});
        }

        const url = `/day/${dayId}/insert-and-reorder`;
        const method = 'POST';
        const body = JSON.stringify({
            new_item_data: data,
            items_to_update: itemsToUpdate
        });

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                itemModal.hide();
                location.reload();
            } else {
                alert('Failed to save item: ' + data.error);
            }
        });
    }
}

function deleteItem(itemId) {
    if (!confirm('Are you sure you want to delete this item?')) {
        return;
    }

    fetch(`/itinerary-item/${itemId}/delete`, {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to delete item: ' + data.error);
        }
    });
}

function toggleActualCosts(itemId) {
    var x = document.getElementById("actual-costs-" + itemId);
    if (x) { // Check if the element exists
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }
}

function deleteActualCost(costId) {
    if (!confirm('Are you sure you want to delete this cost?')) {
        return;
    }

    fetch(`/actual-cost/${costId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`cost-li-${costId}`).remove();
        } else {
            alert('Failed to delete cost.');
        }
    });
}

function addActualCost(itemId) {
    const form = document.getElementById(`add-cost-form-${itemId}`);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/itinerary-item/${itemId}/costs`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const ul = document.querySelector(`#actual-costs-${itemId} ul`);
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between align-items-center';
            li.id = `cost-li-${data.cost.id}`;
            li.innerHTML = `
                ${data.cost.name}: ${data.cost.amount.toFixed(2)} ${data.cost.currency}
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteActualCost('${data.cost.id}')">Delete</button>
            `;
            ul.appendChild(li);
            form.reset();
        } else {
            alert('Failed to add cost.');
        }
    });
}

const currentNavigation = {};

function showTransportSelect(itemId, startLocation, endLocation) {
    if (!startLocation) {
        alert("缺少出发点，请检查上一个项目及其地点是否存在");
        return;
    }

    currentNavigation[itemId] = { start: startLocation, end: endLocation };

    document.getElementById(`navigate-btn-${itemId}`).style.display = 'none';
    document.getElementById(`transport-select-${itemId}`).style.display = 'block';

    const actualCostsBtn = document.getElementById(`actual-costs-btn-${itemId}`);
    if (actualCostsBtn) {
        actualCostsBtn.style.display = 'none';
    }
}

function navigateWithSelectedType(itemId) {
    const selectElement = document.getElementById(`transport-select-${itemId}`);
    const transportType = selectElement.value;
    const navInfo = currentNavigation[itemId];

    if (transportType && navInfo) {
        planRoute(transportType, navInfo.start, navInfo.end);
    }

    // Reset UI
    selectElement.style.display = 'none';
    selectElement.selectedIndex = 0; // Reset to the "Choose..." option
    document.getElementById(`navigate-btn-${itemId}`).style.display = 'block';

    const actualCostsBtn = document.getElementById(`actual-costs-btn-${itemId}`);
    if (actualCostsBtn) {
        actualCostsBtn.style.display = 'block';
    }
}

</script>

<!-- Map Scripts -->
<script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode: '{{ amap_security_key }}',
    };
</script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key={{ amap_key }}&plugin=AMap.Driving,AMap.Walking,AMap.Riding,AMap.Transfer,AMap.Adaptor"></script>
<script>
    var map = new AMap.Map('container', {
        resizeEnable: true, //是否监控地图容器尺寸变化
        zoom: 10, //初始化地图层级
        center: [116.397428, 39.90923] //初始化地图中心点
    });

    var locationCityMap = {{ location_city_map | tojson }};

    var driving, walking, riding, transfer;
    map.on('complete', function() {
        driving = new AMap.Driving({ map: map, panel: "panel" });
        walking = new AMap.Walking({ map: map, panel: "panel" });
        riding = new AMap.Riding({ map: map, panel: "panel" });
        transfer = new AMap.Transfer({ map: map, panel: "panel" });
    });

    function clearRoute() {
        if (driving) driving.clear();
        if (walking) walking.clear();
        if (riding) riding.clear();
        if (transfer) transfer.clear();
    }

    function planRoute(transportType, startLocation, endLocation) {
        clearRoute();
        
        var startCity = locationCityMap[startLocation];
        var endCity = locationCityMap[endLocation];

        var searchPoints = [
            { keyword: startLocation, city: startCity },
            { keyword: endLocation, city: endCity }
        ];

        switch (transportType) {
            case 'Driving':
                driving.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get driving data: ' + result);
                    }
                });
                break;
            case 'Walking':
                walking.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get walking data: ' + result);
                    }
                });
                break;
            case 'Cycling':
                riding.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get cycling data: ' + result);
                    }
                });
                break;
            case 'Public Transport':
                var transCity = startCity; // Default to start city
                if (startCity !== endCity) {
                    console.warn("Cross-city public transport is complex. Using start city for the query.");
                }
                transfer.setCity(transCity);
                transfer.search(searchPoints, function(status, result) {
                    if (status !== 'complete') {
                        alert('Failed to get public transport data: ' + result);
                    }
                });
                break;
            default:
                alert('Unsupported transport type: ' + transportType);
        }
    }
</script>
{% endblock %}