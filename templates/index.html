{% extends 'base.html' %}

{% block content %}
    <div class="container">
        <h1 class="my-4">AI Travel Planner</h1>
        <p>Describe your travel plans below using text or your voice.</p>
        
        <form id="plan-form" action="{{ url_for('generate_plan_route') }}" method="post">
            <div class="mb-3">
                <textarea class="form-control" id="query-text" name="query" rows="5" placeholder="e.g., 'I want to go to Japan for 5 days with a budget of 10,000 CNY...'" ></textarea>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="record-toggle-btn" type="button" class="btn btn-primary">Start Recording</button>
                    <button onclick="recUpload()" type="button" class="btn btn-warning">Upload</button>
                    <span id="status-indicator" class="ms-3">Status: Idle</span>
                </div>
                <button type="submit" class="btn btn-success" id="generate-plan-btn">Generate Plan</button>
                <span id="generate-plan-loading" class="spinner-border spinner-border-sm text-success" role="status" aria-hidden="true" style="display: none;"></span>
                <span id="generate-plan-loading-text" class="ms-2 text-success" style="display: none;">生成中...</span>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/gh/xiangyuecn/Recorder@latest/recorder.mp3.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/xiangyuecn/Recorder@latest/src/engine/pcm.js"></script>
<script>
    var rec, recBlob;
    var isRecording = false;
    var recordToggleBtn = document.getElementById('record-toggle-btn');

    function recOpenAndStart() {
        rec = Recorder({
            type: "pcm",
            sampleRate: 16000,
            bitRate: 16,
            onProcess: function (buffers, powerLevel, bufferDuration, bufferSampleRate) {
                document.getElementById('status-indicator').innerText = 'Recording: ' + (bufferDuration / 1000).toFixed(2) + 's';
            }
        });

        rec.open(function () {
            document.getElementById('status-indicator').innerText = 'Recorder opened';
            rec.start();
            isRecording = true;
            recordToggleBtn.innerText = 'Stop Recording';
            recordToggleBtn.classList.remove('btn-primary');
            recordToggleBtn.classList.add('btn-danger');
            document.getElementById('status-indicator').innerText = 'Recording started';
        }, function (msg, isUserNotAllow) {
            document.getElementById('status-indicator').innerText = 'Recorder failed to open: ' + msg;
            isRecording = false;
            recordToggleBtn.innerText = 'Start Recording';
            recordToggleBtn.classList.remove('btn-danger');
            recordToggleBtn.classList.add('btn-primary');
        });
    }

    function recStopAndClose() {
        rec.stop(function (blob, duration) {
            recBlob = blob;
            isRecording = false;
            recordToggleBtn.innerText = 'Start Recording';
            recordToggleBtn.classList.remove('btn-danger');
            recordToggleBtn.classList.add('btn-primary');
            document.getElementById('status-indicator').innerText = 'Recording stopped';
            rec.close(); // Close the microphone
            rec = null; // Clear the recorder instance
        }, function (msg) {
            document.getElementById('status-indicator').innerText = 'Recording failed: ' + msg;
            isRecording = false;
            recordToggleBtn.innerText = 'Start Recording';
            recordToggleBtn.classList.remove('btn-danger');
            recordToggleBtn.classList.add('btn-primary');
            rec.close(); // Close the microphone even on failure
            rec = null; // Clear the recorder instance
        });
    }

    recordToggleBtn.addEventListener('click', function() {
        if (isRecording) {
            recStopAndClose();
        } else {
            recOpenAndStart();
        }
    });

    function recUpload() {
        if (!recBlob) {
            document.getElementById('status-indicator').innerText = 'No recording to upload';
            return;
        }

        var formData = new FormData();
        formData.append('audio_file', recBlob, 'recording.pcm');

        fetch('/transcribe', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            var queryTextarea = document.getElementById('query-text');
            if (queryTextarea.value) {
                queryTextarea.value += ' '; // Add a space if there's existing text
            }
            queryTextarea.value += data.text;
            document.getElementById('status-indicator').innerText = 'Upload successful';
        })
        .catch(error => {
            console.error('Upload Error:', error);
            document.getElementById('status-indicator').innerText = 'Upload failed: ' + error.message;
        });
    }

    // Handle Generate Plan button click
    const generatePlanBtn = document.getElementById('generate-plan-btn');
    const generatePlanLoading = document.getElementById('generate-plan-loading');
    const generatePlanLoadingText = document.getElementById('generate-plan-loading-text');
    const planForm = document.getElementById('plan-form');

    planForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        generatePlanBtn.disabled = true;
        generatePlanBtn.textContent = '请稍候...'; // Change button text
        generatePlanLoading.style.display = 'inline-block'; // Show spinner
        generatePlanLoadingText.style.display = 'inline'; // Show loading text

        const formData = new FormData(planForm);
        
        fetch(planForm.action, {
            method: planForm.method,
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url; // This handles the error case where a flash message is shown on the index page
                return null; // Stop further processing
            } else if (response.ok) {
                return response.text(); // Get the HTML content of the new page
            } else {
                // If there's an error that doesn't redirect, reload to show flash messages
                window.location.reload();
                return null; // Stop further processing
            }
        })
        .then(html => {
            if (html) {
                // Replace the current document's HTML with the new page's HTML
                document.open();
                document.write(html);
                document.close();
            }
        })
        .catch(error => {
            console.error('Error generating plan:', error);
            alert('生成计划失败: ' + error.message);
            // Re-enable button and hide loading indicator on error
            generatePlanBtn.disabled = false;
            generatePlanBtn.textContent = 'Generate Plan'; // Restore original text
            generatePlanLoading.style.display = 'none';
            generatePlanLoadingText.style.display = 'none';
        });
    });

</script>
{% endblock %}
